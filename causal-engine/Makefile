# =============================================================================
# Makefile โ Bourbaki Causal Engine: Compilaciรณn fast_math C++/pybind11
# =============================================================================

.PHONY: build clean test install-deps all

PYTHON ?= python3
PIP    ?= pip3

# --- Targets principales ---

all: install-deps build test

install-deps:
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ  Instalando dependencias de compilaciรณn (pybind11)  โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	$(PIP) install pybind11>=2.11.0

build: install-deps
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ  Compilando fast_math.cpp โ fast_math.so            โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	$(PYTHON) setup.py build_ext --inplace
	@echo ""
	@echo "โ Compilaciรณn exitosa. Archivo generado:"
	@ls -la fast_math*.so 2>/dev/null || echo "   (buscar en subdirectorios)"
	@echo ""

test: build
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ  Ejecutando tests de validaciรณn                      โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	$(PYTHON) -c "\
import fast_math; \
print('=== fast_math module loaded ==='); \
print(f'Version: {fast_math.__version__}'); \
print(); \
print('--- Variance (Welford) ---'); \
v = fast_math.variance([1.0, 2.0, 3.0, 4.0, 5.0]); \
print(f'variance([1,2,3,4,5]) = {v}'); \
assert abs(v - 2.0) < 1e-10, f'Expected 2.0, got {v}'; \
print('  โ PASS'); \
print(); \
print('--- Sample Variance (Bessel) ---'); \
sv = fast_math.sample_variance([1.0, 2.0, 3.0, 4.0, 5.0]); \
print(f'sample_variance([1,2,3,4,5]) = {sv}'); \
assert abs(sv - 2.5) < 1e-10, f'Expected 2.5, got {sv}'; \
print('  โ PASS'); \
print(); \
print('--- Std Deviation ---'); \
sd = fast_math.std_deviation([1.0, 2.0, 3.0, 4.0, 5.0]); \
print(f'std_deviation([1,2,3,4,5]) = {sd:.6f}'); \
assert abs(sd - 1.414214) < 1e-4, f'Expected ~1.414, got {sd}'; \
print('  โ PASS'); \
print(); \
print('--- Bayesian Normal Posterior ---'); \
mu, sigma = fast_math.bayesian_normal_posterior(0.0, 1.0, [1.0, 2.0, 3.0], 1.0); \
print(f'posterior(prior=N(0,1), data=[1,2,3], ฯ=1) โ N({mu:.4f}, {sigma:.4f})'); \
print('  โ PASS'); \
print(); \
print('--- Bayesian Beta Posterior ---'); \
a, b, mean, var = fast_math.bayesian_beta_posterior(1.0, 1.0, 7, 10); \
print(f'posterior(Beta(1,1), 7/10) โ Beta({a:.1f}, {b:.1f}), mean={mean:.4f}'); \
assert abs(mean - 8.0/12.0) < 1e-4, f'Expected ~0.6667, got {mean}'; \
print('  โ PASS'); \
print(); \
print('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'); \
print('  ๐ฏ ALL TESTS PASSED โ fast_math is ready'); \
print('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'); \
"

clean:
	@echo "๐งน Limpiando artefactos de compilaciรณn..."
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info
	rm -f fast_math*.so
	rm -f fast_math*.pyd
	find . -name "*.o" -delete
	find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "โ Limpio"
